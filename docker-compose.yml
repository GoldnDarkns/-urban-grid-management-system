# Urban Grid Management System - Docker Compose
# Run: docker-compose up -d   (starts everything: backend, frontend, MongoDB, Neo4j, Kafka, producer, consumer)
# Or:  docker-compose up -d --build   (rebuild images then start)
# App: http://localhost (frontend) | http://localhost:8000 (backend API)
# MongoDB: localhost:27017 | Neo4j Browser: http://localhost:7474 | Kafka: localhost:9092

services:
  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
    env_file: .env
    environment:
      - MONGO_URI=${MONGO_URI:-mongodb://mongodb:27017}
      - NEO4J_URI=${NEO4J_URI:-bolt://neo4j:7687}
      - NEO4J_USER=${NEO4J_USER:-neo4j}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-urban-grid-kg}
      - SIM_MONGO_URI=${SIM_MONGO_URI:-mongodb://mongodb:27017}
      - CITY_MONGO_URI=${CITY_MONGO_URI:-mongodb://mongodb:27017}
      - MONGO_DB=${MONGO_DB:-urban_grid_ai}
      - SIM_MONGO_DB=${SIM_MONGO_DB:-urban_grid_ai}
      - CITY_MONGO_DB=${CITY_MONGO_DB:-urban_grid_city}
      - KAFKA_BOOTSTRAP_SERVERS=${KAFKA_BOOTSTRAP_SERVERS:-kafka:9092}
      - KAGGLE_AQI_CSV_PATH=/app/data/Kaggle_Aqi_Downloaded.csv
    dns: [8.8.8.8, 8.8.4.4]
    ports:
      - "8000:8000"
    volumes:
      - ./data:/app/data:ro  # Mount data directory for AQI CSV
    depends_on:
      - mongodb
      - neo4j
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://127.0.0.1:8000/api/health', timeout=5)\" || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 60s

  frontend:
    build:
      context: .
      dockerfile: frontend/Dockerfile
    ports:
      - "80:80"
    depends_on:
      backend:
        condition: service_healthy
    restart: unless-stopped

  mongodb:
    image: mongo:7
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    restart: unless-stopped

  neo4j:
    image: neo4j:5
    ports:
      - "7474:7474"   # HTTP (Browser)
      - "7687:7687"   # Bolt
    environment:
      - NEO4J_AUTH=${NEO4J_AUTH:-neo4j/urban-grid-kg}
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
    volumes:
      - neo4j_data:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:7474 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Phase 2: Kafka (KRaft mode, Apache image â€“ Bitnami not available)
  kafka:
    image: apache/kafka:latest
    container_name: kafka
    ports:
      - "9092:9092"
    environment:
      - KAFKA_NODE_ID=1
      - KAFKA_PROCESS_ROLES=broker,controller
      - KAFKA_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
      - KAFKA_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      - KAFKA_CONTROLLER_QUORUM_VOTERS=1@kafka:9093
      - KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1
      - KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=1
      - KAFKA_TRANSACTION_STATE_LOG_MIN_ISR=1
      - KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS=0
    restart: unless-stopped

  kafka-init:
    image: apache/kafka:latest
    depends_on:
      - kafka
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        echo "Waiting for Kafka..."
        for i in $$(seq 1 30); do
          if /opt/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server kafka:9092 2>/dev/null; then
            echo "Kafka ready."
            break
          fi
          echo "  attempt $$i/30..."
          sleep 2
        done
        for topic in power_demand aqi_stream traffic_events grid_alerts incident_text; do
          /opt/kafka/bin/kafka-topics.sh --create --if-not-exists \
            --bootstrap-server kafka:9092 --partitions 1 --replication-factor 1 --topic "$$topic"
          echo "  Topic $$topic OK"
        done
        echo "All topics created."

  kafka-producer:
    build:
      context: .
      dockerfile: backend/Dockerfile
    env_file: .env
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - KAFKA_PRODUCER_CITY_ID=${KAFKA_PRODUCER_CITY_ID:-nyc}
      - KAFKA_PRODUCER_INTERVAL_SECONDS=${KAFKA_PRODUCER_INTERVAL_SECONDS:-45}
      - BACKEND_BASE_URL=http://backend:8000
      - KAGGLE_AQI_CSV_PATH=/app/data/Kaggle_Aqi_Downloaded.csv
      - KAGGLE_USERNAME=${KAGGLE_USERNAME:-}
      - KAGGLE_KEY=${KAGGLE_KEY:-}
      - PYTHONPATH=/app
    volumes:
      - ./data:/app/data:ro  # Mount data directory for Kaggle CSV
    dns: [8.8.8.8, 8.8.4.4]
    command: ["python", "-m", "backend.kafka_producer"]
    depends_on:
      - kafka
      - kafka-init
      - backend
    restart: unless-stopped

  kafka-consumer:
    build:
      context: .
      dockerfile: backend/Dockerfile
    env_file: .env
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - CITY_MONGO_URI=${CITY_MONGO_URI:-mongodb://mongodb:27017}
      - CITY_MONGO_DB=${CITY_MONGO_DB:-urban_grid_city}
      - PYTHONPATH=/app
    dns: [8.8.8.8, 8.8.4.4]
    command: ["python", "-m", "backend.kafka_consumer"]
    depends_on:
      - kafka
      - kafka-init
      - mongodb
    restart: unless-stopped

volumes:
  mongodb_data:
  neo4j_data:
